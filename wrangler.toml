# Cloudflare Workers Configuration for DOOM INDEX

name = "doom-index"
main = "./src/worker.ts"

compatibility_date = "2025-03-25"
compatibility_flags = [
 "nodejs_compat",
 "nodejs_compat_populate_process_env",
 "global_fetch_strictly_public",
]

# This cause the redundant build when using opennextjs-cloudflare build in local
# [build]
# command = "bun run build:cf"

# Cron Triggers
# IMPORTANT: This cron interval MUST match NEXT_PUBLIC_GENERATION_INTERVAL_MS
# The cron handler executes on every trigger without additional filtering.
#
# Conversion table (NEXT_PUBLIC_GENERATION_INTERVAL_MS -> cron expression):
#   - 10 min (600000ms):   "*/10 * * * *"
#   - 30 min (1800000ms):  "*/30 * * * *"
#   - 1 hour (3600000ms):  "0 * * * *"
#   - 2 hours (7200000ms): "0 */2 * * *"
[triggers]
crons = ["*/10 * * * *"] # Every 10 minutes (NEXT_PUBLIC_GENERATION_INTERVAL_MS=600000)

[[routes]]
pattern = "doomindex.fun"
custom_domain = true

# R2 Bucket Binding
[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "doom-index-storage"
preview_bucket_name = "doom-index-storage"


[[r2_buckets]]
binding = "NEXT_INC_CACHE_R2_BUCKET"
bucket_name = "doom-index-next-inc-cache"
preview_bucket_name = "doom-index-next-inc-cache"

[[d1_databases]]
binding = "DB"
database_name = "doom-index"
database_id = "f953738f-09c7-47bd-8235-2affa996db8e"

# KV Namespace Binding
[[kv_namespaces]]
binding = "VIEWER_KV"
id = "8c588d03a8ab4cd19e0c458dcabf1bec"

# Workers AI Binding
[ai]
binding = "AI"
remote = true

# Next.js on Cloudflare Pages is managed in open-next.config.ts
[assets]
directory = "./.open-next/assets"
binding = "ASSETS"


[[services]]
binding = "WORKER_SELF_REFERENCE"
service = "doom-index"

# Durable Object Queue for ISR revalidation
[[durable_objects.bindings]]
name = "NEXT_CACHE_DO_QUEUE"
class_name = "DOQueueHandler"

# Durable Object Migrations
[[migrations]]
tag = "v1"
new_sqlite_classes = ["DOQueueHandler"]

# Production environment (default/top-level - used when deploying without --env flag)
[vars]
NODE_ENV = "production"
LOG_LEVEL = "INFO"
NEXTJS_ENV = "production"
NEXT_PUBLIC_BASE_URL = "https://doomindex.fun"
IMAGE_MODEL = "runware:106@1"
NEXT_PUBLIC_GENERATION_INTERVAL_MS = 600000 # 10 minutes

[observability]
enabled = false
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = false
persist = true
head_sampling_rate = 1

# Development environment (local development - use with --env dev flag)
[env.dev]

# R2 Bucket Bindings (same resources as production for dev)
[[env.dev.r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "doom-index-storage"
preview_bucket_name = "doom-index-storage"

[[env.dev.r2_buckets]]
binding = "NEXT_INC_CACHE_R2_BUCKET"
bucket_name = "doom-index-next-inc-cache"
preview_bucket_name = "doom-index-next-inc-cache"

# D1 Database Binding (same database as production for dev)
[[env.dev.d1_databases]]
binding = "DB"
database_name = "doom-index"
database_id = "f953738f-09c7-47bd-8235-2affa996db8e"

# KV Namespace Binding (same KV as production for dev)
[[env.dev.kv_namespaces]]
binding = "VIEWER_KV"
id = "8c588d03a8ab4cd19e0c458dcabf1bec"

# Workers AI Binding (same as production for dev)
[env.dev.ai]
binding = "AI"
remote = true

# Service Binding
[[env.dev.services]]
binding = "WORKER_SELF_REFERENCE"
service = "doom-index-dev"

# Durable Object Queue for ISR revalidation (dev environment)
[[env.dev.durable_objects.bindings]]
name = "NEXT_CACHE_DO_QUEUE"
class_name = "DOQueueHandler"

# Durable Object Migrations (dev environment)
[[env.dev.migrations]]
tag = "v1"
new_sqlite_classes = ["DOQueueHandler"]

[env.dev.vars]
NODE_ENV = "development"
LOG_LEVEL = "DEBUG"
NEXTJS_ENV = "development"
NEXT_PUBLIC_BASE_URL = "http://localhost:8787"
IMAGE_MODEL = "runware:106@1"
NEXT_PUBLIC_GENERATION_INTERVAL_MS = 600000 # 10 minutes