# Implementation Plan

- [x] 1. Cloudflare環境解決機能の実装
- [x] 1.1 キャッシュAPIインスタンスの解決機能を実装
  - Cloudflare Workers環境でcaches.defaultに安全にアクセスする機能を実装
  - 環境が利用できない場合にnullを返すグレースフルなフォールバックを実装
  - getCloudflareContext()を使用した環境解決パターンを実装
  - エラーが発生しても例外を投げずにnullを返す動作を実装
  - _Requirements: 3.1, 3.2, 3.3, 3.6_

- [x] 2. 基本キャッシュ操作機能の実装
- [x] 2.1 キャッシュからの値取得機能を実装
  - キーを指定してキャッシュから値を取得する機能を実装
  - キャッシュに値が存在しない場合や期限切れの場合にnullを返す動作を実装
  - キャッシュが利用できない場合でもエラーを投げずにnullを返す動作を実装
  - 型安全性を維持したジェネリック型パラメータの実装
  - namespaceが指定された場合のキー生成ロジックを実装
  - _Requirements: 1.4, 7.1, 7.4_

- [x] 2.2 キャッシュへの値保存機能を実装
  - キーと値を指定してキャッシュに保存する機能を実装
  - TTL（Time-To-Live）を秒単位で指定してキャッシュの有効期限を設定する機能を実装
  - Cache-Controlヘッダーにmax-ageを設定してCloudflare Edge CacheのTTLを制御する機能を実装
  - JSONシリアライズ可能な値をキャッシュに保存する機能を実装
  - キャッシュが利用できない場合でもエラーを投げずに処理をスキップする動作を実装
  - namespaceが指定された場合のキー生成ロジックを実装
  - _Requirements: 1.4, 3.4, 3.5, 6.2, 7.1, 7.4_

- [x] 2.3 キャッシュ値の更新機能を実装
  - キャッシュに値が存在する場合はそれを返し、存在しない場合は計算関数を実行して保存する機能を実装
  - 計算関数の実行結果をキャッシュに保存する機能を実装
  - キャッシュが利用できない場合でも計算関数を実行して結果を返す動作を実装
  - 型安全性を維持したジェネリック型パラメータの実装
  - namespaceが指定された場合のキー生成ロジックを実装
  - _Requirements: 1.1, 1.3, 1.4, 3.4, 3.5, 7.1, 7.4_

- [x] 2.4 キャッシュからの値削除機能を実装
  - キーを指定してキャッシュから値を削除する機能を実装
  - 削除に成功した場合にtrue、失敗または値が存在しない場合にfalseを返す動作を実装
  - キャッシュが利用できない場合でもエラーを投げずにfalseを返す動作を実装
  - namespaceが指定された場合のキー生成ロジックを実装
  - _Requirements: 1.4, 7.1_

- [x] 3. テキスト・バイナリ用キャッシュヘルパーの実装
- [x] 3.1 テキスト値用のキャッシュ操作機能を実装
  - 文字列値をキャッシュから取得する機能を実装
  - 文字列値をキャッシュに保存する機能を実装
  - 文字列値を計算してキャッシュに保存する機能を実装
  - キャッシュが利用できない場合のグレースフルなフォールバックを実装
  - _Requirements: 7.2_

- [x] 3.2 バイナリ値用のキャッシュ操作機能を実装
  - ArrayBuffer値をキャッシュから取得する機能を実装
  - ArrayBuffer値をキャッシュに保存する機能を実装
  - ArrayBuffer値を計算してキャッシュに保存する機能を実装
  - 画像などの重いファイルのレスポンス向上を実現する機能を実装
  - キャッシュが利用できない場合のグレースフルなフォールバックを実装
  - _Requirements: 7.2_

- [x] 4. HTTPレスポンスキャッシュ機能の実装
- [x] 4.1 リクエストベースのHTTPレスポンスキャッシュ機能を実装
  - RequestオブジェクトをキーとしてHTTPレスポンスをキャッシュする機能を実装
  - キャッシュにレスポンスが存在する場合はそれを返し、存在しない場合はレスポンス生成関数を実行して保存する機能を実装
  - TTL経過後は新しいレスポンスを生成する動作を実装
  - キャッシュが利用できない場合でもレスポンス生成関数を実行して結果を返す動作を実装
  - _Requirements: 2.1, 2.3, 3.4_

- [x] 4.2 HTTPヘッダーの処理機能を実装
  - Set-Cookieヘッダーが含まれるレスポンスからヘッダーを削除してからキャッシュに保存する機能を実装
  - Cache-Controlヘッダーが存在しない場合にpublic, max-age={ttlSeconds}を設定する機能を実装
  - ETagやLast-Modifiedヘッダーが存在する場合の互換性を維持する機能を実装
  - Cache-Tagヘッダーが存在する場合にそれを保持する機能を実装
  - _Requirements: 2.2, 2.4, 6.1, 6.2, 6.3_

- [x] 5. 同時リクエストのデデュプリケーション機能の実装
- [x] 5.1 インメモリデデュプリケーション機能を実装
  - 同一キーへの同時リクエストを検出する機能を実装
  - 進行中の計算を追跡するMap構造を実装
  - 同一キーへの同時リクエストが発生した場合に既存の計算Promiseを再利用する機能を実装
  - 計算が完了したらMapから削除する機能を実装
  - リクエスト処理中のみ有効なメモリ管理を実装
  - _Requirements: 1.5_

- [x] 6. エラーハンドリングとロギング機能の実装
- [x] 6.1 エラーハンドリング機能を実装
  - キャッシュ操作（match, put）が失敗した場合に計算関数を実行して結果を返すフォールバック機能を実装
  - 計算関数がエラーを投げた場合にエラーをそのまま伝播し、キャッシュに保存しない動作を実装
  - すべてのエラーをログに記録する機能を実装
  - エラーコンテキスト（キー、TTL、エラー詳細）をログに含める機能を実装
  - _Requirements: 4.1, 4.2_

- [x] 6.2 ロギング統合機能を実装
  - デフォルトのロガーを使用する機能を実装
  - tRPC Contextのloggerをオプショナルパラメータとして受け取る機能を実装
  - loggerが提供された場合はそれを使用し、提供されない場合はデフォルトロガーを使用する機能を実装
  - キャッシュヒット、ミス、put操作をデバッグログとして出力する機能を実装
  - キャッシュが利用できない場合の警告ログを出力する機能を実装
  - キャッシュ操作エラーのエラーログを出力する機能を実装
  - ログレベルに応じた出力制御機能を実装
  - _Requirements: 4.3, 5.7, 7.5_

- [x] 7. ユニットテストの実装
- [x] 7.1 環境解決機能のテストを実装
  - Cloudflare環境が利用可能な場合の動作を検証するテストを実装
  - Cloudflare環境が利用できない場合のnull返却を検証するテストを実装
  - エラー発生時のnull返却を検証するテストを実装
  - _Requirements: 3.1, 3.2_

- [x] 7.2 基本キャッシュ操作のテストを実装
  - get操作のキャッシュヒット時の動作を検証するテストを実装
  - get操作のキャッシュミス時のnull返却を検証するテストを実装
  - get操作のエラー時のnull返却を検証するテストを実装
  - set操作の値保存とTTL設定を検証するテストを実装
  - set操作のnamespace動作を検証するテストを実装
  - set操作のエラー時のグレースフルデグラデーションを検証するテストを実装
  - update操作のキャッシュヒット時の動作を検証するテストを実装
  - update操作のキャッシュミス時の計算実行と保存を検証するテストを実装
  - update操作のTTL設定とnamespace動作を検証するテストを実装
  - remove操作のキャッシュ削除を検証するテストを実装
  - remove操作の存在しないキー削除時のfalse返却を検証するテストを実装
  - remove操作のエラー時のfalse返却を検証するテストを実装
  - _Requirements: 1.1, 1.3, 1.4, 7.1_

- [x] 7.3 テキスト・バイナリ用ヘルパーのテストを実装
  - getText/setText/updateTextの文字列値キャッシュと取得を検証するテストを実装
  - getBinary/setBinary/updateBinaryのArrayBuffer値キャッシュと取得を検証するテストを実装
  - _Requirements: 7.2_

- [x] 7.4 HTTPレスポンスキャッシュのテストを実装
  - withRequestCacheのHTTPレスポンスキャッシュを検証するテストを実装
  - Set-Cookieヘッダーの削除を検証するテストを実装
  - Cache-Controlヘッダーの設定を検証するテストを実装
  - _Requirements: 2.1, 2.2, 6.1, 6.2_

- [x] 7.5 デデュプリケーション機能のテストを実装
  - update操作での同時リクエストのデデュプリケーション動作を検証するテストを実装
  - 同一キーへの複数リクエストで計算が1回のみ実行されることを検証するテストを実装
  - _Requirements: 1.5_

- [x] 7.6 エラーハンドリングのテストを実装
  - キャッシュ操作失敗時のフォールバック動作を検証するテストを実装
  - 計算関数エラーの伝播を検証するテストを実装
  - _Requirements: 4.1, 4.2_

- [x] 8. 統合テストの実装
- [x] 8.1 tRPCルーター統合テストを実装
  - mcRouter.getMarketCapsにget/set操作を適用し、キャッシュヒット時の動作を検証するテストを実装
  - ctx.loggerの使用を検証するテストを実装
  - mcRouter.getRoundedMcMapにget/set操作を適用し、計算結果のキャッシュ動作を検証するテストを実装
  - tokenRouter.getStateにget/set操作を適用し、入力パラメータを含むキー生成を検証するテストを実装
  - r2Router.getJsonにget/set操作を適用し、R2オブジェクトのキャッシュ動作を検証するテストを実装
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.7_

- [x] 8.2 get/setパターンの統合テストを実装
  - get操作とset操作を組み合わせた使用パターンの動作を検証するテストを実装
  - remove操作後のget操作がnullを返すことを検証するテストを実装
  - _Requirements: 1.4, 7.1_

- [x] 8.3 Route Handler統合テストを実装
  - /api/r2/[...key]にwithRequestCacheを適用し、HTTPレスポンスキャッシュの動作を検証するテストを実装
  - _Requirements: 2.1, 3.4_

- [x] 8.4 tRPC Context統合テストを実装
  - tRPC Contextが利用できない環境でのグレースフルデグラデーションを検証するテストを実装
  - _Requirements: 3.3, 3.6_

- [x] 8.5 同時リクエストとTTLの統合テストを実装
  - 同一キーへの同時リクエストでデデュプリケーションが機能することを検証するテストを実装
  - TTL経過後のキャッシュミス動作を検証するテストを実装
  - tRPCプロシージャの戻り値型がキャッシュヘルパーで正しく推論されることを検証するテストを実装
  - _Requirements: 1.5, 7.4_

- [x] 9. tRPCプロシージャへのキャッシュ適用
- [x] 9.1 mcRouterへのキャッシュ適用を実装
  - getMarketCapsプロシージャにupdate操作を適用し、約60秒のTTLでマーケットキャップマップをキャッシュする機能を実装
  - getRoundedMcMapプロシージャにupdate操作を適用し、約60秒のTTLで丸められたマーケットキャップマップをキャッシュする機能を実装
  - ctx.loggerをupdate操作に渡してロギングパターンを統一する機能を実装
  - 外部API（Dex Screener）へのアクセス削減を実現する機能を実装
  - _Requirements: 5.1, 5.2, 5.6, 5.7_

- [x] 9.2 tokenRouterへのキャッシュ適用を実装
  - getStateプロシージャにupdate操作を適用し、30-120秒のTTLでトークン状態データをキャッシュする機能を実装
  - 入力パラメータ（ticker）を含むキー生成ロジックを実装
  - ctx.loggerをupdate操作に渡してロギングパターンを統一する機能を実装
  - クライアントレイテンシの改善を実現する機能を実装
  - _Requirements: 5.3, 5.6, 5.7_

- [x] 9.3 r2Routerへのキャッシュ適用を実装
  - getJsonプロシージャにupdate操作を適用し、データの揮発性に応じた適切なTTLでR2オブジェクトJSONレスポンスをキャッシュする機能を実装
  - ctx.loggerをupdate操作に渡してロギングパターンを統一する機能を実装
  - _Requirements: 5.4, 5.6, 5.7_
