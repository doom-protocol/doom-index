# 実装計画

- [ ] 1. 環境セットアップと依存関係の追加
  - Pinata SDK、Solana web3.js、Solana wallet adapter、three-stdlib をインストール
  - 環境変数に Pinata JWT とSolana RPC URL を追加
  - 型安全な環境変数検証を設定
  - _Requirements: 2.1, 2.2, 5.1_

- [ ] 2. Pinata クライアントと tRPC ルーターの実装
- [ ] 2.1 Pinata クライアントラッパーを作成
  - Pinata SDK を初期化し署名付き URL を生成する機能を実装
  - 環境変数から Pinata JWT を読み取る
  - エラーハンドリングを neverthrow Result 型で実装
  - _Requirements: 2.2, 2.6_

- [ ] 2.2 IPFS 用 tRPC ルーターを作成
  - 署名付き URL 生成プロシージャを実装
  - zod スキーマでリクエストをバリデーション
  - メタデータ（keyvalues）をサポート
  - Result 型を tRPCError に変換
  - メインルーターに統合
  - _Requirements: 2.1, 2.3, 2.4, 2.5, 2.6_

- [ ] 3. GLB エクスポート機能の実装
- [ ] 3.1 GLB エクスポートサービスを作成
  - FramedPainting から絵画モデル（frame.glb + webp テクスチャ）を抽出
  - GLTFExporter でバイナリ GLB を生成
  - File オブジェクトとして返す
  - バックグラウンドで非同期実行
  - _Requirements: 1.1, 1.4_

- [ ] 3.2 エクスポートエラーハンドリングを実装
  - エクスポート失敗時のエラーメッセージを表示
  - リトライ機能を提供
  - _Requirements: 1.2_

- [ ] 4. NFT メタデータ構築機能の実装
- [ ] 4.1 メタデータビルダーユーティリティを作成
  - Metaplex 標準に準拠した JSON を生成
  - GLB CID を image フィールドに設定
  - 絵画のハッシュとタイムスタンプを attributes に追加
  - _Requirements: 4.1, 4.3_

- [ ] 4.2 メタデータ検証ロジックを実装
  - Metaplex 標準への準拠を検証
  - CID フォーマットを検証
  - 必須フィールドの存在を確認
  - _Requirements: 4.3, 4.5_

- [ ] 5. IPFS アップロード機能の実装
- [ ] 5.1 IPFS アップロード Hook を作成
  - 署名付き URL を tRPC 経由で取得
  - GLB ファイルを Pinata にアップロード
  - メタデータ JSON を Pinata にアップロード
  - 両方の CID を返す
  - トランザクション送信と並行して実行
  - _Requirements: 2.1, 3.1, 3.2, 3.6_

- [ ] 5.2 アップロード進行状況の監視を実装
  - アップロード中のローディング状態を表示
  - アップロード完了を通知
  - _Requirements: 3.4_

- [ ] 5.3 アップロードエラーハンドリングとリトライを実装
  - 30 秒タイムアウトを設定
  - タイムアウト時に署名付き URL を再取得
  - 最大 3 回までリトライ
  - エラーメッセージを UI に表示
  - _Requirements: 3.5, 3.7_

- [ ] 6. Solana ウォレット統合の実装
- [ ] 6.1 Solana ウォレット Hook を作成
  - wallet-adapter-react を使用してウォレット接続を実装
  - 接続状態と公開鍵を管理
  - 接続・切断機能を提供
  - _Requirements: 6.2_

- [ ] 6.2 トランザクション署名と送信機能を実装
  - トランザクションオブジェクトを受け取り署名
  - 署名済みトランザクションを Solana RPC に送信
  - トランザクション確認を実行
  - _Requirements: 6.1, 6.3_

- [ ] 7. Solana コントラクト統合の実装
- [ ] 7.1 Solana コントラクト Hook を作成
  - コントラクトからミント料金を取得（1 回のみ）
  - Lamports を SOL と USD に変換
  - ネットワーク手数料を計算
  - 次の tokenId を事前取得
  - タイムアウトとリトライを実装
  - _Requirements: 5.1, 5.2, 5.4_

- [ ] 7.2 ミントトランザクション構築機能を実装
  - 事前取得した tokenId を使用
  - ウォレット公開鍵を設定
  - 最新のブロックハッシュを取得
  - トランザクション送信後に GLB CID とメタデータ CID をコントラクトに紐付け
  - _Requirements: 6.1_

- [ ] 8. Mint モーダル UI の実装
- [ ] 8.1 NFT プレビューモーダルを作成
  - Mint ボタンクリック時にプレビューモーダルを表示
  - 現在表示中の絵画をそのまま表示（エクスポート不要）
  - 絵画のメタデータ（タイムスタンプ、ハッシュ）を表示
  - _Requirements: 1.1_

- [ ] 8.2 料金表示 UI を実装
  - Lamports、SOL、USD 換算を表示
  - ネットワーク手数料と合計額を表示
  - 次の tokenId を表示
  - _Requirements: 5.4_

- [ ] 8.3 ウォレット接続 UI を実装
  - ウォレット未接続時に接続ボタンを表示
  - 接続済み時にウォレットアドレスを表示
  - 切断ボタンを実装
  - ウォレット未接続時は Mint ボタンを無効化
  - _Requirements: 6.2_

- [ ] 8.4 Mint 確認と実行 UI を実装
  - Mint ボタンでトランザクション送信と IPFS アップロードを並行実行
  - トランザクション送信中のローディング状態を表示
  - IPFS アップロード中のローディング状態を表示
  - 両方完了後に成功画面を表示
  - _Requirements: 3.4, 6.3_

- [ ] 8.5 成功画面 UI を実装
  - トランザクション Solscan Explorer リンクを表示
  - Magic Eden NFT ページリンクを表示
  - 次アクション（Twitter シェア/ギャラリーへ戻る）を提供
  - モーダルを閉じる機能を実装
  - _Requirements: 6.4_

- [ ] 9. エラーハンドリングとロギングの実装
- [ ] 9.1 エラーカテゴリ別のハンドリングを実装
  - ユーザーエラー（4xx）のメッセージを表示
  - システムエラー（5xx）のリトライロジックを実装
  - ビジネスロジックエラー（422）の適切な通知を実装
  - _Requirements: 2.6, 3.7, 4.5_

- [ ] 9.2 ロギングとモニタリングを実装
  - 各ステップの実行時間をログに記録
  - エラー発生時に詳細情報をログに記録
  - Cloudflare Workers Analytics に統合
  - _Requirements: All requirements_

- [ ] 10. ギャラリーシーンへの統合
- [ ] 10.1 Mint ボタンを Gallery Scene に追加
  - FramedPainting の近くに Mint ボタンを配置
  - クリック時に Mint モーダルを開く
  - 現在の絵画情報をモーダルに渡す
  - _Requirements: 1.1, 6.1_

- [ ] 10.2 絵画メタデータの取得と渡しを実装
  - 現在表示中の絵画のハッシュとタイムスタンプを取得
  - サムネイル URL を取得
  - Mint モーダルに必要な情報を渡す
  - _Requirements: 1.1, 4.1_

- [ ] 11. テストの実装
- [ ] 11.1 GLB エクスポートのユニットテストを作成
  - エクスポート機能の正常系をテスト
  - エラーケースをテスト
  - バックグラウンド実行をテスト
  - _Requirements: 1.1, 1.4_

- [ ] 11.2 Pinata クライアントのユニットテストを作成
  - 署名付き URL 生成をテスト（モック）
  - エラーハンドリングをテスト
  - メタデータ追加をテスト
  - _Requirements: 2.2, 2.3, 2.6_

- [ ] 11.3 メタデータビルダーのユニットテストを作成
  - Metaplex 標準準拠をテスト
  - CID フォーマットをテスト
  - 必須フィールドの存在をテスト
  - _Requirements: 4.1, 4.3_

- [ ] 11.4 IPFS アップロードフローの統合テストを作成
  - GLB エクスポート → 署名付き URL 取得 → アップロード → CID 取得の一連のフローをテスト
  - トランザクション送信と並行実行をテスト
  - エラーケースとリトライをテスト
  - タイムアウトをテスト
  - _Requirements: 1.1, 2.1, 3.1, 3.6_
