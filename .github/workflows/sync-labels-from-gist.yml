name: Sync labels from Gist preset

on:
  workflow_dispatch: {}

jobs:
  sync-labels:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    env:
      GIST_LABELS_URL: "https://gist.githubusercontent.com/posaune0423/f14ac147719c0a092230adcee652b165/raw/b1c22259e139fae6e764a80c81d2c98165610d17/labels-preset-v1.json"

    steps:
      - name: Fetch labels preset from Gist
        id: fetch
        run: |
          echo "Downloading labels preset from ${GIST_LABELS_URL}"
          curl -fsSL "${GIST_LABELS_URL}" -o labels.json
          jq 'length' labels.json

      - name: Delete existing labels
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const labels = await github.paginate(
              github.rest.issues.listLabelsForRepo,
              { owner, repo, per_page: 100 }
            );

            for (const label of labels) {
              core.info(`Deleting label: ${label.name}`);
              await github.rest.issues.deleteLabel({
                owner,
                repo,
                name: label.name,
              });
            }

      - name: Create labels from preset
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { owner, repo } = context.repo;

            const raw = fs.readFileSync('labels.json', 'utf8');
            const labels = JSON.parse(raw);

            for (const label of labels) {
              core.info(`Creating or updating label: ${label.name}`);
              const payload = {
                owner,
                repo,
                name: label.name,
                color: label.color,
                description: label.description || ''
              };

              try {
                await github.rest.issues.createLabel(payload);
              } catch (error) {
                if (error.status === 422) {
                  // 既に存在する場合は update にフォールバック
                  core.info(`Label exists, updating: ${label.name}`);
                  await github.rest.issues.updateLabel({
                    owner,
                    repo,
                    name: label.name,
                    new_name: label.name,
                    color: label.color,
                    description: label.description || ''
                  });
                } else {
                  throw error;
                }
              }
            }
